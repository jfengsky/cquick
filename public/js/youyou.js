/*! lastmodify: 2015-03-02 14:33:03 */
(function(window,undefined){var doc=document,$G=function(id){return new _$(id);},isIE=false,ieVersion;if(navigator.appName=="Microsoft Internet Explorer"&&navigator.appVersion.match(/7./i)=="7."){isIE=true;
ieVersion=7;}else{if(navigator.appName=="Microsoft Internet Explorer"&&navigator.appVersion.split(";")[1].replace(/[ ]/g,"")=="MSIE6.0"){isIE=true;ieVersion=6;
}}function _$(id){if(typeof(id)==="string"){if(id!=="body"){this.elements=doc.getElementById(id);}else{this.elements=doc.getElementsByTagName("body")[0];
}}else{if(typeof(id)==="object"){this.elements=id;}}}_$.prototype={constructor:_$,hide:function(){this.elements.style.display="none";return this;},show:function(){this.elements.style.display="inline-block";
return this;},remove:function(){this.elements.parentNode.removeChild(this.elements);},attr:function(_key,_value){if(isIE&&ieVersion<=7){if(_value){if(_key==="class"){this.elements.setAttribute("className",_value);
}else{var tempAttr=document.createAttribute(_key);tempAttr.nodeValue=_value+"";this.elements.setAttributeNode(tempAttr);return this;}}else{var tempNode=this.elements.getAttributeNode(_key);
if(tempNode){return tempNode.nodeValue;}else{return undefined;}}}else{if(_value){this.elements.setAttribute(_key,_value);return this;}else{return this.elements.getAttribute(_key);
}}},val:function(_data){if(_data||_data===""){this.elements.value=_data;}else{return this.elements.value;}},append:function(_el){this.elements.appendChild(_el);
return this;},html:function(_string){this.elements.innerHTML=_string;return this;},text:function(){var str="",el=this.elements.childNodes||this.elements;
for(var j=0;j<el.length;j++){str+=el[j].nodeType!=1?el[j].nodeValue:text(el[j].childNodes);}return str;},hasClass:function(_classname){return this.elements.className.match(new RegExp("(\\s|^)"+_classname+"(\\s|$)"))?true:false;
},addClass:function(_classname){if(!$G(this.elements).hasClass(_classname)){this.elements.className+=" "+_classname;}return this;},removeClass:function(_classname){var reg=new RegExp("(\\s|^)"+_classname+"(\\s|$)");
if($G(this.elements).hasClass(_classname)){this.elements.className=this.elements.className.replace(reg," ");}return this;},stringify:function(_obj){if(JSON){return JSON.stringify(_obj);
}else{this.jsonToStr(_obj);}},bind:function(_type,_fn){if(this.elements){if(doc.addEventListener){this.elements.addEventListener(_type,_fn,false);}else{if(doc.attachEvent){this.elements.attachEvent("on"+_type,_fn);
}}}return this;}};var QA=function(){var self=this,questionIndex=1,SEARCHURL="",FEEDBACKURL="",questionFocus=false,cssHasLoad=false,SMALLYOUYOUURL="",isSmallYouyou=false,questionType=2,productId=0,opId="",sendType="jsonp";
this._loadCss=function(_href){var head=doc.getElementsByTagName("head")[0],styleTag=doc.createElement("link");styleTag.setAttribute("type","text/css");
styleTag.setAttribute("rel","stylesheet");styleTag.setAttribute("href",_href);head.appendChild(styleTag);};this._stringify=function(_obj){if(JSON){return JSON.stringify(_obj);
}else{}};this.formatAjaxParams=function(data){var arr=[];for(var name in data){arr.push(encodeURIComponent(name)+"="+encodeURIComponent(data[name]));}arr.push("v="+new Date().getTime());
return arr.join("&");};this.ajax=function(options){options=options||{};options.type=(options.type||"GET").toUpperCase();options.dataType=options.dataType||"json";
var params=this.formatAjaxParams(options.data);if(window.XMLHttpRequest){var xhr=new XMLHttpRequest();}else{var xhr=new ActiveXObject("Microsoft.XMLHTTP");
}xhr.onreadystatechange=function(){if(xhr.readyState==4){var status=xhr.status;var resText;if(status>=200&&status<300){if(isIE&&ieVersion<=7){if(xhr.responseText.indexOf("function")===-1){resText=eval("("+xhr.responseText+")");
}}else{resText=JSON.parse(xhr.responseText);}options.success&&options.success(resText,xhr.responseXML);}else{options.fail&&options.fail(status);}}};if(options.type=="GET"){xhr.open("GET",options.url+"?"+params,true);
xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.send(null);}};this._formatParams=function(data){var arr=[];
for(var name in data){arr.push(encodeURIComponent(name)+"="+encodeURIComponent(data[name]));}return arr.join("&");};this.jsonp=function(_options){_options=_options||{};
if(!_options.url||!_options.callback){throw new Error("参数不合法");}var callbackName=("jsonp"+new Date().getTime());var oHead=doc.getElementsByTagName("head")[0];
_options.data[_options.callback]=callbackName;var params=this._formatParams(_options.data);var oS=doc.createElement("script");oHead.appendChild(oS);window[callbackName]=function(json){oHead.removeChild(oS);
clearTimeout(oS.timer);window[callbackName]=null;_options.success&&_options.success(json);};oS.src=_options.url+"?"+params;if(_options.timeout){oS.timer=setTimeout(function(){window[callbackName]=null;
oHead.removeChild(oS);_options.fail&&_options.fail({message:"超时"});},_options.timeout);}};this._smallWinTpl='<div class="youyou_title"><h1>游游助手<i id="J_youyouboxclose">x</i></h1></div><div class="body-search" id="J_bodysearch"><div class="box" id="J_chatbox"><div id="chat0"><p class="vbk_ctrip">游游助手</p><div class="basefix"><div class="left_box yellow_bg">您好，我是机器人游游，很高兴为您服务。</div></div></div></div></div><div class="output"><input type="text" placeholder="请输入文字" id="J_question"><a href="javascript:void(0)" class="send yy_halfalpha" id="J_send">发送</a></div>';
this._quesTpl=function(_question,_index){return'<div class="vbk_client_box"><span class="J_serr" id="J_serr'+_index+'" style="display:none">发送失败,请点击重新发送 </span><p class="vbk_client_pass">'+_question+'</p></div><p class="vbk_client_box" id="J_stime'+_index+'"></p></div>';
};this._scrollBottom=function(){var scrollCnt=doc.getElementById("J_bodysearch"),distance=99999+(questionIndex*400);if(scrollCnt){scrollCnt.scrollTop=distance;
}else{window.scrollTo(0,distance);}};this._formatDate=function(_date){var dateArr=[],tempDate=new Date(_date);dateArr[0]=tempDate.getFullYear();dateArr[1]=tempDate.getMonth()+1;
dateArr[2]=tempDate.getDate();dateArr[3]=tempDate.getHours();dateArr[4]=tempDate.getMinutes();return dateArr[0]+"-"+dateArr[1]+"-"+dateArr[2]+" "+dateArr[3]+":"+dateArr[4];
};this._dataError=function(){$G("J_serr"+questionIndex).show();self._sending(true);};this._lightKeyword=function(_string,_kerword){var tempString=_string,reg="";
for(var i=0,leg=_kerword.length;i<leg;i++){reg=new RegExp(_kerword[i],"ig");tempString=tempString.replace(reg,'<span class="red">'+_kerword[i]+"</span>");
}return tempString;};this._feedBack=function(_index,_rid,_nameIndex){var tempName="feedback_"+_index+"_"+_nameIndex;return'<div class="choose_box"><label><input data-type="feedback" type="radio" value="1" data-rid="'+_rid+'" name="'+tempName+'">好用</label><label><input data-type="feedback" type="radio" value="2" data-rid="'+_rid+'" name="'+tempName+'">一般</label><label><input data-type="feedback" type="radio" value="3" data-rid="'+_rid+'" name="'+tempName+'">不好用</label></div>';
};this._relateAnswer=function(_data){var tempStr="";if(_data&&_data.length){for(var i=0,leg=_data.length;i<leg;i++){tempStr+="<p>"+(i+1)+', <a href="javascript:void(0)" data-type="relatequest" data-k=\''+_data[i].K+"'>"+_data[i].Q+"</a><p>";
}return'<div class="ask_box"><p>相关问题：</p>'+tempStr+"</div>";}else{return"";}};this._emptyAnswer=function(_resTime){return'<p class="vbk_ctrip">游游助手</p><div><div class="vbk_ctrip_info">我太笨了，不知道你这个问题的答案，见笑了^-^</div></div><p class="vbk_ctrip">'+_resTime+"</p>";
};this._fuzzyTpl=function(_index,_resTime,_searchResult,_searchResultKeyWord){var answerStr="",relateStr="",KeyWordArr=_searchResult.TK,fuzzyAnswer=_searchResult.SR,lightClass="",feedbackTpl="";
if(fuzzyAnswer&&fuzzyAnswer.length){for(var i=0;i<fuzzyAnswer.length;i++){if(i===0&&questionType===2){lightClass="yellow_bg";}else{lightClass="";}if(questionType===2){feedbackTpl=this._feedBack(_index,fuzzyAnswer[i].RID,i);
}else{feedbackTpl="";}answerStr+='<div><div class="vbk_ctrip_info '+lightClass+'">'+this._lightKeyword(fuzzyAnswer[i].R,KeyWordArr)+" ["+fuzzyAnswer[i].SN+", "+fuzzyAnswer[i].S+"]"+feedbackTpl+"</div></div>";
}relateStr=this._relateAnswer(_searchResult.RQ);return'<p class="vbk_ctrip">游游助手</p>'+answerStr+relateStr+'<p class="vbk_ctrip">'+_resTime+"</p>";}else{return"";
}};this._showAnswer=function(_index,_resTime,_searchResult){var answerCont=this._viewCont(_index,"answer"),answerTpl=this._fuzzyTpl(_index,_resTime,_searchResult);
$G("J_chatbox").append(answerCont);if(!_searchResult.RQ&&!_searchResult.SR){$G("asw"+_index).html(self._emptyAnswer(_resTime));}else{$G("asw"+_index).html(answerTpl);
}};this._answers=function(_data){var data=_data.data,index=data.SQ,sendTime=self._formatDate(data.RQT-0),resTime=self._formatDate(data.RPT-0);$G("J_serr"+index).remove();
$G("J_stime"+index).html(sendTime);self._showAnswer(index,resTime,data);self._sending(true);self._scrollBottom();questionIndex++;};this._sendData=function(_options){var sendOption={url:_options.url,callback:"callback",data:{param:self._stringify(_options.param)},success:function(_data,_str){if(_data.errno===0&&_options.callback){_options.callback(_data);
}else{if(_options.error){_options.error();}}},fail:function(){if(_options.error){_options.error();}},timeout:20000};if(sendType==="ajax"){this.ajax(sendOption);
}else{this.jsonp(sendOption);}};this._sending=function(_bool){if(_bool){$G("J_send").addClass("yy_halfalpha");$G("J_send").html("发送");$G("J_question").val("");
}else{$G("J_send").removeClass("yy_halfalpha");}};this._viewCont=function(_index,_type){var content=doc.createElement("div");if(_type==="question"){content.setAttribute("id","chat"+_index);
}else{content.setAttribute("id","asw"+_index);}return content;};this._showQuestion=function(_question){var tpl=this._viewCont(questionIndex,"question"),chatTpl=this._quesTpl(_question,questionIndex);
$G("J_chatbox").append(tpl);$G("chat"+questionIndex).html(chatTpl);this._scrollBottom();};this.checkString=function(_string){if(_string===""){alert("请输入您的问题");
return false;}else{if(/[$%&<>\/\\]/.test(_string)){alert("不能输入特殊字符");return false;}}return true;};this._sendRelateData=function(_obj){var sendKey=$G(_obj).attr("data-k"),questionChar=$G(_obj).text();
questionType=1;self._showQuestion(questionChar);self._sending(true);$G("J_send").html("发送中...");this._sendData({url:SEARCHURL,param:{M:1,PID:productId,K:sendKey,SQ:questionIndex},callback:self._answers,error:self._dataError});
};this._sendFeedBack=function(_obj){var radioRid=$G(_obj).attr("data-rid")-0,radioVal=$G(_obj).val()-0;this._sendData({url:FEEDBACKURL,param:{RID:radioRid,FR:radioVal,EID:opId},callback:null,error:null});
};this._sendEvent=function(){var tempQuestion=$G("J_question").val();if(!$G("J_send").hasClass("yy_halfalpha")){questionType=2;if(self.checkString(tempQuestion)){self._showQuestion(tempQuestion);
self._sending(true);$G("J_send").html("发送中...");self._sendData({url:SEARCHURL,param:{M:2,PID:productId,K:escape(tempQuestion),SQ:questionIndex},callback:self._answers,error:self._dataError});
}}};this._bind=function(){$G("J_question").bind("focus",function(){questionFocus=true;});$G("J_question").bind("blur",function(){questionFocus=false;});
$G("J_chatbox").bind("click",function(ev){var evTarget=ev.srcElement?ev.srcElement:ev.target;var targetType=$G(evTarget).attr("data-type");if(targetType==="feedback"){self._sendFeedBack(evTarget);
}else{if(targetType==="relatequest"){self._sendRelateData(evTarget);}}});$G("J_bindproduct").bind("click",function(){productId=prompt("请输入需要绑定的产品Id")||0;
if(productId!==0){$G(this).hide();$G("J_pkgid").html(productId);$G("J_unbindproductcnt").show();productId=parseInt(productId)||0;}});$G("J_unbindproduct").bind("click",function(){productId=0;
$G("J_unbindproductcnt").hide();$G("J_bindproduct").show();$G("J_pkgid").html("");});};this._sendButton=function(){$G("J_send").bind("click",this._sendEvent);
$G(doc).bind("keyup",function(ev){if(questionFocus&&ev.keyCode!==13){var queStr=$G("J_question").val();if(queStr.length>0){$G("J_send").removeClass("yy_halfalpha");
}else{$G("J_send").addClass("yy_halfalpha");}}if(questionFocus&&ev.keyCode===13){self._sendEvent();}});};this._offlineClick=function(){var youyouButton=$G("youyou"),isShow=youyouButton.attr("data-show");
if(isShow==="true"){$G("J_youyou_box").hide();youyouButton.attr("data-show","false");}else{if(isShow==="false"){$G("J_youyou_box").show();youyouButton.attr("data-show","true");
self._scrollBottom();}else{self._loadCss(SMALLYOUYOUURL);var content=doc.createElement("div");content.setAttribute("id","J_youyou_box");if(isIE&&ieVersion<=7){content.setAttribute("className","youyou_box");
content.style.position="absolute";content.style.left="10px";content.style.bottom=0;}else{content.setAttribute("class","youyou_box");content.setAttribute("style","position:fixed;_position:absolute;bottom:0;left:10px;z-index:1000");
}$G("body").append(content);$G("J_youyou_box").html(self._smallWinTpl);self._bind();self._sendButton();youyouButton.attr("data-show","true");cssHasLoad=true;
}}};this._boxInit=function(){this._offlineClick();$G("youyou").bind("click",this._offlineClick);$G("J_youyouboxclose").bind("click",function(){$G("J_youyou_box").hide();
$G("youyou").attr("data-show","false");});if(isIE&&ieVersion<=7){$G(window).bind("scroll",function(){var disTop=document.documentElement.scrollTop+(document.documentElement.clientHeight-602);
$G("J_youyou_box").elements.style.top=disTop+"px";});}};this.init=function(_options){SEARCHURL=_options.searchUrl;FEEDBACKURL=_options.feedBackUrl;SMALLYOUYOUURL=_options.cssUrl;
productId=_options.productId||0;opId=_options.EID||"";sendType=_options.sendType;if(_options.pageType==="offline"){isSmallYouyou=true;}if(isSmallYouyou){this._boxInit();
}else{this._bind();this._sendButton();}};};window.QA=QA;})(window);